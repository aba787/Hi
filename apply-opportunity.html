<body>
  <h1>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±ØµØ©</h1>
  <div id="opportunity-details">
    <!-- Ù‡Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ØµØ© -->
  </div>

  <button id="applyBtn">ğŸ“ ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙØ±ØµØ©</button>
  <p id="statusMsg"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlMibtDbLAZLMhhJNho5Sih_qBfWxZyXI",
      authDomain: "momaken-45ba9.firebaseapp.com",
      projectId: "momaken-45ba9",
      storageBucket: "momaken-45ba9.appspot.com",
      messagingSenderId: "638133555280",
      appId: "1:638133555280:web:c84bd87c15cabe55d30155"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const applyBtn = document.getElementById("applyBtn");
    const statusMsg = document.getElementById("statusMsg");
    const params = new URLSearchParams(window.location.search);
    const opportunityId = params.get("id");

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      loadOpportunity();
    });

    async function loadOpportunity() {
      const docRef = doc(db, "opportunities", opportunityId);
      const snapshot = await getDoc(docRef);
      if (!snapshot.exists()) {
        document.getElementById("opportunity-details").textContent = "Ø§Ù„ÙØ±ØµØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
        applyBtn.style.display = "none";
        return;
      }

      const opp = snapshot.data();
      document.getElementById("opportunity-details").innerHTML = `
        <h3>${opp.title}</h3>
        <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${opp.date}</p>
        <p>Ø§Ù„ÙØ¦Ø©: ${opp.category}</p>
        <p>Ø§Ù„ÙˆØµÙ: ${opp.description}</p>
      `;
    }

    applyBtn.addEventListener("click", async () => {
      try {
        // 1. Ø£Ø¶Ù Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
        await addDoc(collection(db, "applications"), {
          userId: currentUser.uid,
          opportunityId,
          status: "pending",
          createdAt: serverTimestamp()
        });

        // 2. Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¬Ù…Ø¹ÙŠØ©
        const oppRef = doc(db, "opportunities", opportunityId);
        const oppSnap = await getDoc(oppRef);
        const opp = oppSnap.data();

        await addDoc(collection(db, "notifications"), {
          to: opp.associationId,
          message: `ğŸ“© Ù…ØªØ·ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ Ù‚Ø¯Ù… Ø¹Ù„Ù‰ ÙØ±ØµØ© "${opp.title}"`,
          type: "application",
          read: false,
          createdAt: serverTimestamp()
        });

        statusMsg.textContent = "âœ… ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!";
        applyBtn.disabled = true;
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ….";
      }
    });
  </script>
</body>